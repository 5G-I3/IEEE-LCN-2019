# Scripts to measure basic properties of the testbed

## Overview

The scripts in this directory were used to measure and analyze the basic
properties of the IoT-LAB testbed at the [Lille] site.

`ping-stats.py` runs 10 experiments in parallel that pick 2 nodes from the
testbed each which are no further apart than 20 m. Each experiment runs for 5
minutes. New experiments are started as long as the script is not aborted
(in which case all running experiments are stopped). The results will be stored
in a CSV file at `../../results/distance_test.csv` or alternatively at a path
configured by the `DATA_PATH` environment variable.

`plot-ping-stats.py` plots the results in
`../results/distance_test.csv`. Alternatively, the path to the results can be
provided as an argument.

## Requirements

The scripts assume they are run with Python 3.

The following python packages are required (version numbers indicate tested
versions):

- `iotlabcli` v2.5
- `matplotlib` v3.1

The required packages are listed in `requirements.txt` and can be installed
using

```sh
pip3 install -r requirements.txt
```

You will also require a version of the `ssh` command (e.g. `openssh-client`) to
interact with the IoT-LAB nodes.

You must also configure your IoT-LAB credentials using `iotlab-auth` which is
provided by the `iotlabcli` python package. See

```sh
iotlab-auth -h
```

for further instructions.

## Usage

### `ping-stats.py`

This script starts a number of concurrent experiments that measure the
reliability of a link between two random nodes using 500 ICMPv6 echo
requests/replies with in 50ms intervals, timing out 100 ms (which is counted as
a packet loss).

The script requires a RIOT firmware for M3 `firmware.elf` that supports the
`ping6` and `ifconfig` shell commands to be in this directory. Alternatively,
the path to the firmware can be provided in the environment variable
`FIRMWARE_ELF`.

The RIOT examples `gnrc_networking` ships both required shell commands, so we
can just use that:

```sh
export BOARD=iotlab-m3
make -C ../../RIOT/examples/gnrc_networking
cp ../../RIOT/examples/gnrc_networking/bin/${BOARD}/gnrc_networking.elf firmware.elf
```

If all requirements are met and nodes are available at the Lille site the script
should now be able to run. You can check your [IoT-LAB Dashboard] to check if
the deployment is working

```sh
./ping-stats.py
```

Once a run is done, its results will be amended to the results in results CSV.
It contains the following columns:

- `exp_id`: the experiment ID of the IoT-LAB experiment the measurement ran in
- `node1`: the node number of the pinging node (it's domain corresponds to
  `m3-<node1>.lille.iot-lab.info`)
- `node2`: the node number of the pinged node (it's domain corresponds to
  `m3-<node2>.lille.iot-lab.info`)
- `d`: the distance in meters between the node. The distance is calculated from
  the position data of the nodes provided by the IoT-LAB CLI tools
- `packet loss`: packet loss in percent (over one run of `ping6`)

#### Environment variables

- `DATA_PATH`: (default: `./../../results`) Path to store the results CSV
  `distance_test.csv` in
- `FIRMWARE_ELF`: (default: `./firmware.elf`) Path to the firmware for the
  measurement experiments

### `plot-ping-stats.py`

With the results of a number of runs generated by `ping-stats.py`,
`plot-ping-stats.py` can be used to analyze them.

With default configuration of `plot-ping-stats.py` just run

```
./plot-ping-stats.py
```

and a plot will be shown. The plot maps distances in meters to packet loss rate
in percent. Gray error bars in the background mark the mean and standard
deviation of packet loss at that exact distance. Additionally, the distances are
binned to the nearest round meter (orange, vertical lines mark their bounds).
Those bins are summarized as a box plot. The features of those box plots where
not changed from their default configuration in `matplotlib`

#### Parameters
The path to the results CSV can be changed with the first parameter to the
script. This is useful if multiple results CSVs where generated.

```
./plot-ping-stats.py <results_csv>
```

#### Environment variables
- `DATA_PATH`: (default: `./../../results`) Path to `distance_test.csv` and
  where an SVG file of the plot will be stored

[Lille]: https://www.iot-lab.info/deployment/lille/
[IoT-LAB Dashboard]: https://www.iot-lab.info/testbed/dashboard
